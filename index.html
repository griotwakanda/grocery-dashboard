<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Griot — Grocery Mission Control</title>
  <style>
    :root {
      --bg: #05070c;
      --panel: rgba(255, 255, 255, 0.06);
      --panel-strong: rgba(255, 255, 255, 0.10);
      --text: #f4f6ff;
      --muted: #9aa5c0;
      --accent: #58c8ff;
      --accent-strong: #7ee5c6;
      --danger: #ff6b6b;
      --radius: 20px;
      --shadow: 0 20px 45px rgba(3, 5, 11, 0.6);
      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background:
        radial-gradient(circle at top right, rgba(88, 200, 255, 0.25), transparent 45%),
        radial-gradient(circle at 10% 20%, rgba(126, 229, 198, 0.2), transparent 45%),
        var(--bg);
      color: var(--text);
    }

    .page {
      width: min(1200px, 100%);
      margin: 0 auto;
      padding: 32px 20px 60px;
    }

    header.hero {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 24px;
    }

    header.hero .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 13px;
      color: var(--muted);
    }

    header.hero h1 {
      margin: 0;
      font-size: clamp(2rem, 3vw, 2.8rem);
      letter-spacing: -0.02em;
    }

    .eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.3em;
      font-size: 11px;
      color: var(--muted);
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .card {
      background: var(--panel);
      border-radius: var(--radius);
      padding: 18px 20px;
      border: 1px solid var(--panel-strong);
      box-shadow: var(--shadow);
    }

    .card strong {
      display: block;
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .value {
      font-size: clamp(1.6rem, 3vw, 2.2rem);
      margin: 0;
    }

    .delta {
      margin-top: 6px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .panels {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }

    .panel-group {
      display: grid;
      gap: 18px;
    }

    .panel-title {
      margin: 0 0 12px;
      font-size: 0.95rem;
      letter-spacing: 0.05em;
      color: var(--muted);
      text-transform: uppercase;
    }

    .bars {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bar-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }

    .bar-row span.label {
      font-size: 0.85rem;
      color: var(--text);
    }

    .bar-track {
      height: 6px;
      width: 100%;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--accent), var(--accent-strong));
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th,
    td {
      padding: 10px 8px;
    }

    th {
      text-align: left;
      font-size: 0.75rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--muted);
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    td {
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      color: var(--text);
    }

    td.numeric {
      font-family: 'Courier New', monospace;
      text-align: right;
      color: var(--muted);
    }

    ul.suggestions {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    ul.suggestions li {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 12px 14px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      gap: 12px;
    }

    ul.suggestions li::before {
      content: '•';
      color: var(--accent);
      font-size: 1.4rem;
      line-height: 1;
    }

    .tag {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      background: rgba(255, 255, 255, 0.08);
      color: var(--muted);
    }

    .footer-note {
      margin-top: 24px;
      font-size: 0.75rem;
      color: var(--muted);
      text-align: right;
    }

    @media (max-width: 600px) {
      .panels {
        grid-template-columns: 1fr;
      }

      table th,
      table td {
        padding: 8px 4px;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="hero">
      <span class="eyebrow">Grocery Mission Control</span>
      <h1>Spend with purpose</h1>
      <p class="subtitle" id="subtitle">Loading insights…</p>
      <div class="meta">
        <span id="receiptCount">0 receipts</span>
        <span id="avgVisit">— avg per visit</span>
        <span id="lastUpdated">last synced —</span>
      </div>
    </header>

    <section class="kpi-grid">
      <div class="card">
        <strong>Spend total</strong>
        <p class="value" id="totalSpend">—</p>
        <p class="delta" id="totalNote">All time</p>
      </div>
      <div class="card">
        <strong>Produce bias</strong>
        <p class="value" id="produceShare">—</p>
        <p class="delta">Focus on fruits & veg</p>
      </div>
      <div class="card">
        <strong>Protein spend</strong>
        <p class="value" id="proteinSpend">—</p>
        <p class="delta">Fuel lean gains</p>
      </div>
      <div class="card">
        <strong>Ultra-processed</strong>
        <p class="value" id="ultraSpend">—</p>
        <p class="delta" id="ultraPct">—</p>
      </div>
    </section>

    <div class="panels">
      <div class="panel-group">
        <div class="card" aria-live="polite">
          <p class="panel-title">Realtime suggestions</p>
          <ul class="suggestions" id="suggestions">
            <li>Loading suggestions…</li>
          </ul>
        </div>
        <div class="card">
          <p class="panel-title">Top categories</p>
          <div class="bars" id="catBars"></div>
        </div>
      </div>

      <div class="panel-group">
        <div class="card">
          <p class="panel-title">Top items (by spend)</p>
          <table>
            <thead>
              <tr>
                <th>Item</th>
                <th>Category</th>
                <th class="numeric">Total</th>
              </tr>
            </thead>
            <tbody id="topItems"></tbody>
          </table>
        </div>
        <div class="card">
          <p class="panel-title">Latest receipts</p>
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Store</th>
                <th class="numeric">Subtotal</th>
                <th class="numeric">Tax</th>
                <th class="numeric">Total</th>
              </tr>
            </thead>
            <tbody id="receiptsTbl"></tbody>
          </table>
        </div>
      </div>
    </div>

    <p class="footer-note">Built for Daniel — actionable insights in CAD. Update time: <span id="footerTimestamp">—</span></p>
  </div>

  <script>
    const fmt = (value) => {
      if (value == null || Number.isNaN(value)) return '—';
      return new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD' }).format(value);
    };

    const parseCsv = (text) => {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',').map((h) => h.trim());
      return lines.slice(1).filter(Boolean).map((line) => {
        const cols = line.split(',');
        const row = {};
        headers.forEach((h, idx) => {
          row[h] = cols[idx] ? cols[idx].trim() : '';
        });
        return row;
      });
    };

    const sum = (arr, fn) => arr.reduce((acc, item) => acc + (fn(item) || 0), 0);

    const groupSum = (items, keyFn, valFn) => {
      const map = new Map();
      items.forEach((item) => {
        const key = keyFn(item);
        const value = Number(valFn(item)) || 0;
        map.set(key, (map.get(key) || 0) + value);
      });
      return [...map.entries()]
        .map(([k, v]) => ({ k, v }))
        .sort((a, b) => b.v - a.v);
    };

    const inferSuggestions = ({ receipts, items, produceShare, ultraPct, average }) => {
      const suggestions = [];
      if (produceShare < 0.35) {
        suggestions.push('Dial up produce: swap one ultra-processed snack for fresh greens to keep your plate colorful.');
      } else {
        suggestions.push('Great produce coverage — keep stacking seasonal fruit for fiber and micronutrients.');
      }

      if (average > 35) {
        suggestions.push('Average visit is high → plan a bulk list and shop once per week to shave prep time.');
      }

      const frequentUltra = items
        .filter((it) => it.tags && it.tags.includes('ultra-processed'))
        .map((it) => it.normalized_item)
        .filter(Boolean);
      if (frequentUltra.length) {
        suggestions.push(`Move toward whole-food swaps: consider replacing ${frequentUltra[0]} with a protein-forward option.`);
      }

      if (receipts.length && receipts[receipts.length - 1].store) {
        suggestions.push(`Last stop: ${receipts[receipts.length - 1].store} — log transport details to keep the logistics pipeline aligned.`);
      }

      return suggestions.slice(0, 4);
    };

    async function load() {
      const [receiptsText, itemsText] = await Promise.all([
        fetch('./receipts.csv', { cache: 'no-store' }).then((r) => r.text()),
        fetch('./line_items.csv', { cache: 'no-store' }).then((r) => r.text()),
      ]);

      const receipts = parseCsv(receiptsText);
      const items = parseCsv(itemsText);

      const totalSpend = sum(receipts, (r) => Number(r.total) || 0);
      const average = receipts.length ? totalSpend / receipts.length : 0;
      const produceSpend = sum(items.filter((li) => li.category === 'produce'), (li) => Number(li.line_total) || 0);
      const proteinSpend = sum(items.filter((li) => li.category === 'protein' || li.tags?.includes('protein')), (li) => Number(li.line_total) || 0);
      const ultraSpend = sum(items.filter((li) => li.tags?.includes('ultra-processed')), (li) => Number(li.line_total) || 0);
      const produceShare = totalSpend ? produceSpend / totalSpend : 0;
      const ultraPct = totalSpend ? ultraSpend / totalSpend : 0;

      document.getElementById('totalSpend').textContent = fmt(totalSpend);
      document.getElementById('totalNote').textContent = receipts.length ? `${receipts.length} visits tracked` : 'No receipts yet';
      document.getElementById('produceShare').textContent = produceShare ? `${(produceShare * 100).toFixed(1)}%` : '—';
      document.getElementById('proteinSpend').textContent = fmt(proteinSpend);
      document.getElementById('ultraSpend').textContent = fmt(ultraSpend);
      document.getElementById('ultraPct').textContent = ultraPct ? `${(ultraPct * 100).toFixed(1)}% of spend` : '—';
      document.getElementById('receiptCount').textContent = `${receipts.length} receipts`; 
      document.getElementById('avgVisit').textContent = average ? `${fmt(average)} avg per visit` : '— avg per visit';

      const catSummary = groupSum(
        items.filter((li) => li.category && !['fee', 'deposit', 'discount'].includes(li.category)),
        (li) => li.category,
        (li) => li.line_total
      ).slice(0, 6);

      const catBars = document.getElementById('catBars');
      catBars.innerHTML = '';
      const maxCat = Math.max(1, ...catSummary.map((row) => row.v));
      catSummary.forEach((row) => {
        const el = document.createElement('div');
        el.className = 'bar-row';
        el.innerHTML = `
          <span class="label">${row.k}</span>
          <div style="display:flex;align-items:center;gap:8px;">
            <div class="bar-track"><div class="bar-fill" style="width:${Math.round((row.v / maxCat) * 100)}%"></div></div>
            <span class="numeric">${fmt(row.v)}</span>
          </div>
        `;
        catBars.appendChild(el);
      });

      const topItems = groupSum(
        items.filter((li) => li.normalized_item && Number(li.line_total)),
        (li) => li.normalized_item,
        (li) => li.line_total
      ).slice(0, 6);

      const itemsEl = document.getElementById('topItems');
      itemsEl.innerHTML = '';
      topItems.forEach((entry) => {
        const matching = items.find((li) => li.normalized_item === entry.k);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${entry.k}</td>
          <td>${matching?.category || '—'}</td>
          <td class="numeric">${fmt(entry.v)}</td>
        `;
        itemsEl.appendChild(tr);
      });

      const receiptsEl = document.getElementById('receiptsTbl');
      const sortedReceipts = [...receipts].sort((a, b) => (b.date || '').localeCompare(a.date || '')).slice(0, 8);
      receiptsEl.innerHTML = '';
      sortedReceipts.forEach((receipt) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${receipt.date || ''}</td>
          <td>${receipt.store || ''}</td>
          <td class="numeric">${fmt(Number(receipt.subtotal) || 0)}</td>
          <td class="numeric">${fmt(Number(receipt.tax) || 0)}</td>
          <td class="numeric">${fmt(Number(receipt.total) || 0)}</td>
        `;
        receiptsEl.appendChild(tr);
      });

      const suggestions = inferSuggestions({ receipts, items, produceShare, ultraPct, average });
      const suggestionsEl = document.getElementById('suggestions');
      suggestionsEl.innerHTML = suggestions.length
        ? suggestions.map((text) => `<li>${text}</li>`).join('')
        : '<li>All systems green — keep up the good work.</li>';

      const now = new Date();
      document.getElementById('subtitle').textContent = `Insights updated ${now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
      document.getElementById('lastUpdated').textContent = `Last sync ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
      document.getElementById('footerTimestamp').textContent = now.toLocaleString();
    }

    load().catch((err) => {
      const subtitle = document.getElementById('subtitle');
      subtitle.textContent = 'Failed to load grocery data.';
      document.getElementById('suggestions').innerHTML = `<li>${err.message}</li>`;
    });
  </script>
</body>
</html>
